@page "/teacherallcourses"
@inject AuthenticationStateProvider GetAuthenticationStateAsync
@inject IAppUserDtoClient appuserClient
@inject NavigationManager Navigation
@inject IXDtoClient xClient
@inject XNavMenu xnav
@attribute [Authorize]
@*Av Björn Lindqvist*@
@*Endast lärare har åtkomst hit*@

<PageTitle>Teacher all courses</PageTitle>

<AuthorizeView Roles="Teacher">
    <Authorized>
        <nav style="display: flex; width: 100%">
            <div style="width: 75%; text-align: left"><h4>@TeacherName</h4></div>
            <div style="margin-left: auto; margin-right: 0">
                <button type="button" class="text-white delbtn" @onclick="AddDeleteAvatar" title="Add or delete avatar">A</button>
                <button type="button" class="text-white delbtn" @onclick="DeleteAllDocs" title="Delete all documents and messages">E</button>
            </div>
        </nav>

        <div class="container" @onmouseover="DeleteRefresh"> @*Eventuella dokument som ingår läggs ut här*@
            <div class="d-flex flex-wrap">
                @foreach (var doc in documents)
                {
                    <ul class="nav">
                        @if (doc.UserId == loggeduser.Id && doc.Id4Course != -2 && doc.ActivityId == 0)
                        {
                            if (doc.DocName != "")
                            {
                                if (DateTime.Parse(doc.TimeStamp).AddDays(1) > DateTime.Now)
                                {
                                    <li class="doclink" style="background-color:lavenderblush; box-shadow: 0 0 10px plum">
                                        <span @onclick=" _ => OpenFileControl(doc.NameIx, doc.DocName)" title="Personal post">@doc.DocName</span>
                                        <span class="oi oi-file text-primary text-decoration-none docicon"
                                        @onclick=" _ => DocUserControl(doc.Id, true)"></span>
                                    </li>
                                }
                                else
                                {
                                    <li class="doclink" style="background-color:lavenderblush">
                                        <span @onclick=" _ => OpenFileControl(doc.NameIx, doc.DocName)" title="Personal post">@doc.DocName</span>
                                        <span class="oi oi-file text-primary text-decoration-none docicon"
                                        @onclick=" _ => DocUserControl(doc.Id, true)"></span>
                                    </li>
                                }
                            }
                            else
                            {
                                if (DateTime.Parse(doc.TimeStamp).AddDays(1) > DateTime.Now)
                                {
                                    <li class="oi oi-file text-danger text-decoration-none docicon"
                                        style="position: relative; top: 10px; margin-right: 22px; text-shadow: 0 0 10px plum"
                                        @onmouseover=" _ => ShowMessControl(doc.Description, doc.Author, doc.TimeStamp)"
                                        @onclick=" _ => DeleteMess(doc.Id)">
                                    </li>
                                }
                                else
                                {
                                    <li class="oi oi-file text-danger text-decoration-none docicon"
                                        style="position: relative; top: 10px; margin-right: 22px"
                                        @onmouseover=" _ => ShowMessControl(doc.Description, doc.Author, doc.TimeStamp)"
                                        @onclick=" _ => DeleteMess(doc.Id)">
                                    </li>
                                }
                            }
                        }
                    </ul>
                }
            </div>
        </div><br />

        <DocumentAvatar @ref="addavatarRef" /> @*Avatar-fönster*@
        <DeleteAllDocUser @ref="deletealldocRef" /> @*Delete-fönster*@
        <DeleteMess @ref="deleteRef" /> @*Delete-fönster*@
        <DocumentUser @ref="docuserRef" /> @*Filmottagarefönster*@

        <EditForm Context="searchlmslexnet" Model="@courses" OnSubmit="OnInitializedAsync" @onmouseover="DeleteRefresh">
            <span class="nav m-lg-auto input-group">
                <InputText class="form-control" @bind-Value="searchString" placeholder="Course name" />
                <span class="nav m-lg-auto input-group-append">
                    <button type="submit" class="btn m-lg-auto btn-outline-dark">Search</button>
                </span>
                <span class="nav m-lg-auto input-group-append">
                    <button type="button" class="btn m-lg-auto btn-outline-dark" @onclick="ReverseOrder">@textBtn</button>
                </span>
            </span>
        </EditForm><br />

        @do
        {
            RepeatTable = false;
            if (courses == null)
            {
                <p><em>Loading...</em></p>
            }
            else
            {
                foreach (var data in courses)
                {
                    <section class="coursebox" @onmouseover="DeleteRefresh">
                        <div style="display: flex; width: 100%">
                            <div style="width: 75%; text-align: left">
                                @data.Id.&nbsp; <em style="cursor: pointer" title="@data.Description -Click for edit-"
                                @onclick=" _ => RedirectToCourse(data.Id)">@data.Name</em>

                                @if (data.Total_M == 1) SP = "module"; else SP = "modules";
                                <span style="margin-left: 2%; color:sandybrown" class="dropuse">
                                    <span><span>@data.Total_M</span><span>&nbsp;@SP,</span></span>
                                    <span style="font-size: 0.78rem; padding: 3px; cursor: default" class="dropuse-content">
                                        @foreach (var item in modules) // Snabbtitt.
                                        {
                                            if (item.CourseId == data.Id)
                                            {
                                                <div>@item.Name</div>
                                            }
                                        }
                                    </span>
                                </span>

                                @if (data.Total_S == 1) SP = "participant"; else SP = "participants";
                                <span style="margin-left: 2%; color:slategray" class="dropuse">
                                    <span><span>@data.Total_S</span><span>&nbsp;@SP,</span></span>
                                    <span style="font-size: 0.78rem; padding: 3px; cursor: default" class="dropuse-content">
                                        @foreach (var item in users) // Snabbtitt.
                                        {
                                            if (item.CourseId == data.Id)
                                            {
                                                if (item.UserRole == 1)
                                                {
                                                    <div>@item.FirstName @item.LastName</div>
                                                }

                                                if (item.UserRole == 2)
                                                {
                                                    <div style="color:darkred">@item.FirstName @item.LastName</div>
                                                }
                                            }
                                        }
                                    </span>
                                </span>

                                @if (data.Total_D == 1) SP = "document"; else SP = "documents";
                                <span style="margin-left: 2%; color:darkblue" class="dropuse">
                                    <span><span>@data.Total_D</span><span>&nbsp;@SP</span></span>
                                    <span style="font-size: 0.78rem; padding: 3px; cursor: pointer" class="dropuse-content">
                                        @foreach (var item in documents) // Snabbtitt och som här gäller alla ev dokument i en kurs.
                                        {
                                            if (item.Id4Course == data.Id)
                                            {
                                                if (item.DocName != "")
                                                {
                                                    <div @onclick=" _ => OpenFileControl(item.NameIx, item.DocName)"
                                                    title="@item.Description, @item.Author, @item.TimeStamp">@item.DocName</div>
                                                }
                                                else
                                                {
                                                    <div @onclick=" _ => ShowMessControl(item.Description, item.Author, item.TimeStamp)"
                                                    style="color:rebeccapurple">From @item.Author</div>
                                                }
                                            }

                                            foreach (var mod in modules)
                                            {
                                                if (mod.CourseId == data.Id && item.ModuleId == mod.Id)
                                                {
                                                    <div @onclick=" _ => OpenFileControl(item.NameIx, item.DocName)"
                                                    title="@item.Description, @item.Author, @item.TimeStamp">@item.DocName</div>
                                                }

                                                foreach (var act in activities)
                                                {
                                                    if (mod.CourseId == data.Id && act.ModuleId == mod.Id && item.ActivityId == act.Id)
                                                    {
                                                        if (item.DocName != "")
                                                        {
                                                            <div @onclick=" _ => OpenFileControl(item.NameIx, item.DocName)"
                                                            title="@item.Description, @item.Author, @item.TimeStamp">@item.DocName</div>
                                                        }
                                                        else
                                                        {
                                                            <div @onclick=" _ => ShowMessControl(item.Description, item.Author, item.TimeStamp)"
                                                            style="color:rebeccapurple">From @item.Author</div>
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    </span>
                                </span>

                            </div>
                                <b style="margin-left: auto">@StartEndDate(data.StartDate, data.EndDate)</b>&nbsp;
                                @if (data.Total_M > 0)
                                {
                                    <div style="margin-left: auto; margin-right: 0">
                                        <NavLink style="cursor: pointer" class="oi oi-circle-x text-danger text-decoration-none"
                                        @onclick=" _ => DeleteControl(data.Id)" Title="Delete course"></NavLink>
                                    </div>
                                }
                                else
                                {
                                    <div style="margin-left: auto">
                                        <NavLink style="cursor: pointer" class="oi oi-circle-x text-danger text-decoration-none"
                                        @onclick=" _ => DeleteControl(data.Id)" Title="Delete course"></NavLink>
                                    </div>
                                    <div style="margin-left: auto; margin-right: 0">
                                        <NavLink style="cursor: pointer; margin-left: 1%" class="oi oi-browser text-primary text-decoration-none"
                                        @onclick=" _ => AddModule(data.Id)" Title="Add a blank module"></NavLink>
                                    </div>  
                                }
                        </div>
                    </section>
                }
            }
        } while (RepeatTable);

    </Authorized>
    <NotAuthorized>
        <h5 style="font-weight: bold; color: red">You are not authorized to visit this page...</h5>
    </NotAuthorized>
</AuthorizeView>

@code {

    private DocumentAvatar? addavatarRef; // Avatar-fönster.

    private void AddDeleteAvatar() // Avatar-fönster.
    {
        Auxx.Name4Type = loggeduser.FirstName + ' ' + loggeduser.LastName;
        Auxx.Loggeduser = loggeduser;
        addavatarRef!.Show();
    }

    private DeleteAllDocUser? deletealldocRef; // Delete-fönster.

    private void DeleteAllDocs() // Delete-fönster.
    {
        Auxx.Loggeduser = loggeduser;
        deletealldocRef!.Show();
    }

    private DeleteMess? deleteRef; // Delete-fönster.

    private void DeleteMess(int id) // Delete-fönster.
    {
        Auxx.IntId = id;
        deleteRef!.Show();
    }

    private async Task DeleteRefresh() // Uppdaterar efter förändring av innehållet.
    {
        if (Auxx.Flag)
        {
            Auxx.Flag = false;
            await OnInitializedAsync();
        }
    }

    private DocumentUser? docuserRef; // Filmottagarefönster.

    private void DocUserControl(int id, bool delete) // Filmottagarefönster.
    {
        Auxx.IntId = id;
        Auxx.Flag = delete;
        Auxx.Documents = documents;
        docuserRef!.Show();
    }

    private List<CourseDto> courses = new();

    private List<ModuleDto> modules = new();

    private List<ActivityDto> activities = new();

    private List<DocumentDto> documents = new();

    private List<AppUserDto> users = new();

    private AppUserDto loggeduser = new(); // Info om den som för tillfället är inloggad.

    private string TeacherName = string.Empty;
    private string searchString = string.Empty;
    private string SP = string.Empty;
    private string textBtn = "First first";
    private bool DeleteFlag;
    private bool RepeatTable;

    protected override async Task OnInitializedAsync()
    {
        xnav.SetReset('a');

        courses.Clear(); // Sökfunktionen kräver att listorna rensas.
        modules.Clear();
        activities.Clear();
        documents.Clear();
        users.Clear();

        var authstate = await GetAuthenticationStateAsync.GetAuthenticationStateAsync();
        var user = authstate.User;
        var name = user.Identity?.Name!; // Email för den som för tillfället är inloggad.

        var course = await xClient.GetAsync<IEnumerable<CourseDto>>("api/Course");
        var module = await xClient.GetAsync<IEnumerable<ModuleDto>>("api/Module");
        var activity = await xClient.GetAsync<IEnumerable<ActivityDto>>("api/Activity");
        var document = await xClient.GetAsync<IEnumerable<DocumentDto>>("api/Document");
        var appuser = await appuserClient.GetAsync();

        if (module is not null) modules = module.ToList(); // För snabbtitt.
        if (activity is not null) activities = activity.ToList();
        if (document is not null) documents = document.ToList();
        if (appuser is not null) users = appuser.ToList();

        if (course is not null)
        {
            foreach (var item in course)
            {
                // Sökfiltrering med IndexOf: kursnamn.
                if (!string.IsNullOrWhiteSpace(searchString))
                {
                    if (item.Name.ToLower().IndexOf(searchString.ToLower()) != - 1) courses.Add(item);
                }
                else
                {
                    courses.Add(item);
                }
            }
            courses = Enumerable.Reverse(courses).ToList();
        }

        foreach (var c in courses) // Räknar samman alla kursdokument.
        {
            int FindDoc = 0;

            foreach (var d in documents)
            {
                if (d.Id4Course == c.Id) c.Total_D++;
            }

            foreach (var m in c.Modules)
            {
                foreach (var d in documents)
                {
                    if (d.ModuleId == m.Id) FindDoc++;

                    foreach (var a in m.Activities)
                    {
                        if (d.ActivityId == a.Id) FindDoc++;
                    }
                }
            }
            c.Total_D += FindDoc;
        }

        if (appuser is not null && name is not null)
        {
            foreach (var item in appuser) // Hämtar den som för tillfället är inloggad.
            {
                if (item.Email == name) loggeduser = item;
            }
        }

        xnav.SetLogAvatar("d-none", "");

        foreach (var doc in documents) // Letar efter en avatar.
        {
            if (doc.UserId == loggeduser.Id && doc.Id4Course == -2)
            {
                xnav.SetLogAvatar("avatarlog", xClient.GetFilepath() + doc.NameIx + doc.DocName);
            }
        }

        TeacherName = $"Hello, {loggeduser.FirstName} {loggeduser.LastName}!";
    }

    private async Task DeleteControl(int id)
    {
        foreach (var cour in courses)
        {
            if (cour.Id == id)
            {
                DeleteFlag = true;

                foreach (var mod in cour.Modules) // Kollar om det finns några moduler.
                {
                    DeleteFlag = false;
                }

                var appuser = await appuserClient.GetAsync();

                if (appuser is not null)
                {
                    foreach (var user in appuser) // Kollar om det finns några användare knutna till kursen.
                    {
                        if (user.CourseId == id) DeleteFlag = false;
                    }
                }

                var document = await xClient.GetAsync<IEnumerable<DocumentDto>>("api/Document");

                if (document is not null)
                {
                    foreach (var doc in document) // Kollar om det finns några dokument knutna till kursen.
                    {
                        if (doc.Id4Course == id) DeleteFlag = false;
                    }
                }
            }
        }

        if (DeleteFlag)
        {
            xnav.SetDone("xnavdone", "This course was deleted.");
            xnav.SetReset('d');
            await Intermission(3000, false);
            await xClient.RemAsync(id, "api/Course");
            Navigation.NavigateTo("/teacherallcourses", true);
            DeleteFlag = false;
        }
        else
        {
            await Intermission(100, true);
            xnav.SetError("xnaverror", "All modules, activities, document, message, and users belonging to a course" +
            " must first be deleted or redirected before a course can be deleted.");
            xnav.SetReset('e');
        }
    }

    private void ReverseOrder()
    {
        if (textBtn == "First first") textBtn = "Last first"; else textBtn = "First first";
        courses = Enumerable.Reverse(courses).ToList();
        RepeatTable = true;
    }

    private string StartEndDate(DateTime start, DateTime end) // Returnerar datumsträng.
    {
        return $"{start.ToString().Substring(0, 10)} | {end.ToString().Substring(0, 10)}";
    }

    private void RedirectToCourse(int id)
    {
        Navigation.NavigateTo($"/coursedetail/{id}", true);
    }

    private async Task AddModule(int id)
    {
        int ModuleID = 0;

        var lmod = new ModuleDto
            {
                Name = "Not yet a name",
                Description = "Not yet a description",
                StartDate = DateTime.Now,
                EndDate = DateTime.Now,
                IsActive = true,
                CourseId = id
            };

            await xClient.PostAsync<ModuleDto>(lmod, "api/Module");

            var allmod = await xClient.GetAsync<IEnumerable<ModuleDto>>("api/Module");

            if (allmod is not null)
            {
                foreach (var mod in allmod)
                {
                    if (mod.Name == lmod.Name && mod.StartDate == lmod.StartDate && mod.EndDate == lmod.EndDate) ModuleID = mod.Id;
                }
            }

            var lact = new ActivityDto
                {
                    Name = "Not yet a name",
                    Description = "Not yet a description",
                    StartDate = DateTime.Now,
                    EndDate = DateTime.Now,
                    IsActive = true,
                    ActivityTypeId = 1,
                    ModuleId = ModuleID
                };

            await xClient.PostAsync<ActivityDto>(lact, "api/Activity");
            await CreateAndRefresh(id);
    }

    private async Task CreateAndRefresh(int id)
    {
        xnav.SetDone("xnavdone", "An empty module was added.");
        xnav.SetReset('d');
        await Intermission(2000, false);
        Navigation.NavigateTo($"/coursedetail/{id}", true);
    }

    private async Task OpenFileControl(int ix, string filename)
    {
        await xClient.OpenFile(ix, filename);
    }

    private void ShowInfoControl(string description, string author, string timestamp)
    {
        xnav.SetInfo("xnavinfo", description + " by " + author + " Created: " + timestamp);
        xnav.SetReset('i');
    }

    private void ShowMessControl(string description, string author, string timestamp)
    {
        xnav.SetMess("xnavmess", description + " by " + author + " Created: " + timestamp);
        xnav.SetReset('m');
    }

    private async Task Intermission(int time, bool hide) // Paus.
    {
        if (hide)
        {
            xnav.SetReset('a');
        }
        base.StateHasChanged();
        await Task.Delay(time);
    }
}